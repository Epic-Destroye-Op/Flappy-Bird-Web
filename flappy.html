<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flappy Bird Deluxe</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@700;900&family=Press+Start+2P&display=swap');
        
        :root {
            --easy-color: #4CAF50;
            --moderate-color: #FF9800;
            --hard-color: #F44336;
            --sky-day: linear-gradient(to bottom, #87CEEB, #E0F7FA);
            --sky-morning: linear-gradient(to bottom, #FF7F50, #FFD700);
            --sky-evening: linear-gradient(to bottom, #8A2BE2, #FF4500);
            --sky-night: linear-gradient(to bottom, #0F2027, #203A43, #2C5364);
            --sky-rain: linear-gradient(to bottom, #4B79A1, #283E51);
            --text-glow: 0 0 10px currentColor;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: #121212;
            font-family: 'Poppins', sans-serif;
            overflow: hidden;
            touch-action: manipulation;
        }
        
        #game-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        
        #game-container {
            position: relative;
            width: 400px;
            height: 600px;
            overflow: hidden;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            transition: background 5s ease, transform 0.2s ease;
            background: var(--sky-day);
            will-change: transform;
        }
        
        #game-container.fullscreen {
            width: 100vw;
            height: 100vh;
            border-radius: 0;
            transform: scale(1) !important;
        }
        
        #game-container.morning {
            background: var(--sky-morning);
        }
        
        #game-container.evening {
            background: var(--sky-evening);
        }
        
        #game-container.night {
            background: var(--sky-night);
        }
        
        #game-container.rain {
            background: var(--sky-rain);
        }
        
        #menu {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 20;
            transition: all 0.3s ease;
            opacity: 1;
        }
        
        #menu.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        #game-over {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            color: white;
            z-index: 20;
            transform: scale(0.9);
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        #game-over.show {
            display: flex;
            transform: scale(1);
            opacity: 1;
        }
        
        .title {
            font-family: 'Press Start 2P', cursive;
            font-size: 2.5rem;
            margin-bottom: 2rem;
            text-align: center;
            background: linear-gradient(to right, #FFD700, #FF8C00, #FF4500);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: var(--text-glow);
            animation: titlePulse 2s infinite alternate;
        }
        
        @keyframes titlePulse {
            0% { transform: scale(1); }
            100% { transform: scale(1.05); }
        }
        
        .difficulty-buttons {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            width: 80%;
        }
        
        .btn {
            padding: 15px 30px;
            font-size: 1.2rem;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 1;
            will-change: transform;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.1);
            z-index: -1;
            transition: all 0.3s ease;
            opacity: 0;
        }
        
        .btn:hover::before {
            opacity: 1;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }
        
        .btn:active {
            transform: translateY(1px);
        }
        
        #easy-btn {
            background: var(--easy-color);
            color: white;
        }
        
        #moderate-btn {
            background: var(--moderate-color);
            color: white;
        }
        
        #hard-btn {
            background: var(--hard-color);
            color: white;
        }
        
        #menu-btn {
            background: linear-gradient(to right, #00B4DB, #0083B0);
            color: white;
            margin-bottom: 10px;
        }
        
        #retry-btn {
            background: linear-gradient(to right, #FF512F, #DD2476);
            color: white;
        }
        
        #bird {
            position: absolute;
            width: 40px;
            height: 30px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 40 30"><path d="M20,5 Q30,15 20,25 Q10,15 20,5" fill="%23FFD700" stroke="%23D4A017" stroke-width="2"/><circle cx="30" cy="10" r="3" fill="%23333"/><path d="M10 15 L15 10 L10 10 Z" fill="%23FF4500"/></svg>');
            background-size: contain;
            background-repeat: no-repeat;
            z-index: 10;
            filter: drop-shadow(0 0 5px rgba(255, 215, 0, 0.7));
            transform-origin: center;
            will-change: transform;
        }
        
        .pipe {
            position: absolute;
            width: 70px;
            background: linear-gradient(to right, #2E8B57, #3CB371);
            border-left: 4px solid #228B22;
            border-right: 4px solid #228B22;
            z-index: 5;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
            will-change: transform;
        }
        
        .pipe-top {
            border-top: 4px solid #228B22;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
        }
        
        .pipe-bottom {
            border-bottom: 4px solid #228B22;
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
        }
        
        .pipe::after {
            content: '';
            position: absolute;
            width: 80px;
            height: 20px;
            background: linear-gradient(to right, #228B22, #2E8B57);
            left: -5px;
            border-radius: 5px;
        }
        
        .pipe-top::after {
            bottom: 0;
        }
        
        .pipe-bottom::after {
            top: 0;
        }
        
        .cloud {
            position: absolute;
            background: white;
            border-radius: 50%;
            opacity: 0.9;
            filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.5));
            z-index: 1;
            will-change: transform;
        }
        
        .star {
            position: absolute;
            background: white;
            width: 2px;
            height: 2px;
            border-radius: 50%;
            animation: twinkle 2s infinite alternate;
            z-index: 0;
            will-change: transform;
        }
        
        @keyframes twinkle {
            0% { opacity: 0.2; }
            100% { opacity: 1; }
        }
        
        #score-display, #high-score-display {
            position: absolute;
            color: white;
            text-shadow: 0 0 10px rgba(0, 0, 0, 0.7);
            font-size: 1.2rem;
            z-index: 15;
            background: rgba(0, 0, 0, 0.4);
            padding: 5px 15px;
            border-radius: 20px;
            backdrop-filter: blur(2px);
            will-change: transform;
        }
        
        #score-display {
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            font-weight: bold;
            font-size: 1.5rem;
            animation: scorePulse 0.5s ease;
        }
        
        @keyframes scorePulse {
            0% { transform: translateX(-50%) scale(1); }
            50% { transform: translateX(-50%) scale(1.2); }
            100% { transform: translateX(-50%) scale(1); }
        }
        
        #high-score-display {
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
        }
        
        #final-score {
            font-size: 1.8rem;
            margin: 1rem 0;
            text-shadow: var(--text-glow);
            color: #FFD700;
        }
        
        .particle {
            position: absolute;
            background: gold;
            border-radius: 50%;
            pointer-events: none;
            z-index: 30;
            will-change: transform;
        }
        
        .ground {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 50px;
            background: linear-gradient(to right, #8B4513, #A0522D);
            z-index: 8;
            box-shadow: 0 -5px 10px rgba(0, 0, 0, 0.3);
        }
        
        .ground::before {
            content: '';
            position: absolute;
            top: -10px;
            width: 100%;
            height: 20px;
            background: linear-gradient(to right, #556B2F, #6B8E23);
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
        }
        
        .sun {
            position: absolute;
            width: 80px;
            height: 80px;
            background: radial-gradient(circle, #FFD700, #FF8C00);
            border-radius: 50%;
            top: 50px;
            right: 50px;
            z-index: 0;
            box-shadow: 0 0 50px #FF8C00;
            animation: sunPulse 5s infinite alternate;
            will-change: transform;
        }
        
        @keyframes sunPulse {
            0% { transform: scale(1); box-shadow: 0 0 50px #FF8C00; }
            100% { transform: scale(1.05); box-shadow: 0 0 70px #FF4500; }
        }
        
        .moon {
            position: absolute;
            width: 60px;
            height: 60px;
            background: radial-gradient(circle, #F5F5F5, #D3D3D3);
            border-radius: 50%;
            top: 50px;
            right: 50px;
            z-index: 0;
            box-shadow: 0 0 30px white;
            display: none;
            will-change: transform;
        }
        
        .night .sun {
            display: none;
        }
        
        .night .moon {
            display: block;
        }
        
        .flare {
            position: absolute;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0) 70%);
            pointer-events: none;
            opacity: 0.1;
            z-index: 2;
        }
        
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #f00;
            opacity: 0;
            z-index: 100;
            will-change: transform;
        }
        
        .medal {
            position: absolute;
            width: 80px;
            height: 80px;
            background-size: contain;
            background-repeat: no-repeat;
            top: 30%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            z-index: 25;
            animation: medalDrop 1s forwards;
        }
        
        @keyframes medalDrop {
            0% { transform: translate(-50%, -100px) rotate(-30deg); opacity: 0; }
            100% { transform: translate(-50%, 0) rotate(0); opacity: 1; }
        }
        
        .glow {
            position: absolute;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, rgba(255,215,0,0.3) 0%, rgba(255,215,0,0) 70%);
            pointer-events: none;
            z-index: 1;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        
        .glow.active {
            opacity: 1;
        }
        
        .credits {
            position: absolute;
            bottom: 10px;
            left: 0;
            width: 100%;
            text-align: center;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.8rem;
            z-index: 30;
        }
        
        .reset-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            background: #F44336;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
            cursor: pointer;
            z-index: 30;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }
        
        .reset-btn:hover {
            transform: scale(1.1);
            background: #D32F2F;
        }
        
        .reset-modal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 350px;
            z-index: 100;
            display: none;
            backdrop-filter: blur(5px);
            border: 2px solid #F44336;
        }
        
        .reset-modal.show {
            display: block;
        }
        
        .reset-modal h3 {
            color: #F44336;
            margin-top: 0;
            text-align: center;
        }
        
        .reset-modal p {
            color: white;
            font-size: 0.9rem;
            line-height: 1.4;
            margin-bottom: 20px;
        }
        
        .reset-modal-btns {
            display: flex;
            justify-content: space-between;
        }
        
        .reset-modal-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .reset-modal-btn.cancel {
            background: #757575;
            color: white;
        }
        
        .reset-modal-btn.continue {
            background: #F44336;
            color: white;
        }
        
        .reset-modal-btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        .difficulty-highscore {
            font-size: 0.8rem;
            margin-top: 5px;
            color: white;
            opacity: 0.8;
        }
        
        .rain-drop {
            position: absolute;
            width: 2px;
            height: 15px;
            background: rgba(255, 255, 255, 0.6);
            animation: rainFall linear infinite;
            z-index: 2;
        }
        
        @keyframes rainFall {
            to {
                transform: translateY(600px);
            }
        }
        
        .lightning {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            opacity: 0;
            z-index: 3;
            pointer-events: none;
        }
        
        @media (max-aspect-ratio: 2/3) {
            #game-container:not(.fullscreen) {
                transform: scale(0.8);
            }
        }
        
        @media (max-aspect-ratio: 1/2) {
            #game-container:not(.fullscreen) {
                transform: scale(0.6);
            }
        }
    </style>
</head>
<body>
    <div id="game-wrapper">
        <div id="game-container">
            <div class="flare"></div>
            <div class="glow"></div>
            <div class="sun"></div>
            <div class="moon"></div>
            <div class="ground"></div>
            <div class="lightning"></div>
            
            <div id="menu">
                <div class="reset-btn" id="reset-btn">!</div>
                <h1 class="title">Flappy Bird Deluxe</h1>
                <div class="difficulty-buttons">
                    <button id="easy-btn" class="btn">Easy Mode
                        <div class="difficulty-highscore">High: <span id="easy-highscore">0</span></div>
                    </button>
                    <button id="moderate-btn" class="btn">Moderate Mode
                        <div class="difficulty-highscore">High: <span id="moderate-highscore">0</span></div>
                    </button>
                    <button id="hard-btn" class="btn">Hardcore Mode
                        <div class="difficulty-highscore">High: <span id="hard-highscore">0</span></div>
                    </button>
                </div>
                <div class="credits">Made with ♥ by EpicDestroyerOp</div>
            </div>
            
            <div id="game-over">
                <h1 class="title">Game Over</h1>
                <div id="medal" class="medal"></div>
                <p id="final-score">Score: 0</p>
                <button id="retry-btn" class="btn">Retry</button>
                <button id="menu-btn" class="btn">Main Menu</button>
                <div class="credits">Made with ♥ by EpicDestroyerOp</div>
            </div>
            
            <div id="bird"></div>
            <div id="score-display">0</div>
            <div id="high-score-display">High: 0</div>
            
            <div class="reset-modal" id="reset-modal">
                <h3>⚠️ Warning! ⚠️</h3>
                <p>This will completely reset all game progress and high scores.</p>
                <p>Only use this if you're experiencing issues or want a fresh start.</p>
                <div class="reset-modal-btns">
                    <button class="reset-modal-btn cancel" id="reset-cancel-btn">Cancel</button>
                    <button class="reset-modal-btn continue" id="reset-continue-btn">Reset Game</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Game elements
        const gameWrapper = document.getElementById('game-wrapper');
        const gameContainer = document.getElementById('game-container');
        const menu = document.getElementById('menu');
        const gameOverScreen = document.getElementById('game-over');
        const bird = document.getElementById('bird');
        const scoreDisplay = document.getElementById('score-display');
        const highScoreDisplay = document.getElementById('high-score-display');
        const finalScoreDisplay = document.getElementById('final-score');
        const easyBtn = document.getElementById('easy-btn');
        const moderateBtn = document.getElementById('moderate-btn');
        const hardBtn = document.getElementById('hard-btn');
        const menuBtn = document.getElementById('menu-btn');
        const retryBtn = document.getElementById('retry-btn');
        const medal = document.getElementById('medal');
        const glow = document.querySelector('.glow');
        const resetBtn = document.getElementById('reset-btn');
        const resetModal = document.getElementById('reset-modal');
        const resetCancelBtn = document.getElementById('reset-cancel-btn');
        const resetContinueBtn = document.getElementById('reset-continue-btn');
        const easyHighscoreDisplay = document.getElementById('easy-highscore');
        const moderateHighscoreDisplay = document.getElementById('moderate-highscore');
        const hardHighscoreDisplay = document.getElementById('hard-highscore');
        const lightning = document.querySelector('.lightning');
        
        // Game variables
        let gameRunning = false;
        let score = 0;
        let currentDifficulty = '';
        let highScores = {
            easy: parseInt(localStorage.getItem('flappyHighScoreEasy')) || 0,
            moderate: parseInt(localStorage.getItem('flappyHighScoreModerate')) || 0,
            hard: parseInt(localStorage.getItem('flappyHighScoreHard')) || 0
        };
        let gravity;
        let pipeSpeed;
        let pipeGap;
        let pipeFrequency;
        let jumpForce;
        let birdY = 300;
        let birdVelocity = 0;
        let pipes = [];
        let clouds = [];
        let stars = [];
        let rainDrops = [];
        let animationId;
        let pipeTimer;
        let cloudTimer;
        let starTimer;
        let rainTimer;
        let timeOfDay = 'day';
        let timeOfDayTimer;
        let lastFrameTime = 0;
        let isRaining = false;
        let gameScale = 1;
        
        // Game dimensions
        const gameWidth = 400;
        const gameHeight = 600;
        const baseWidth = 400;
        const baseHeight = 600;
        
        // Initialize game
        function initGame() {
            updateAllHighScoreDisplays();
            setupEventListeners();
            createInitialEnvironment();
            handleResize();
            window.addEventListener('resize', handleResize);
        }
        
        function setupEventListeners() {
            easyBtn.addEventListener('click', () => startGame('easy'));
            moderateBtn.addEventListener('click', () => startGame('moderate'));
            hardBtn.addEventListener('click', () => startGame('hard'));
            menuBtn.addEventListener('click', returnToMenu);
            retryBtn.addEventListener('click', restartGame);
            document.addEventListener('keydown', handleKeyPress);
            gameContainer.addEventListener('click', handleClick);
            resetBtn.addEventListener('click', showResetModal);
            resetCancelBtn.addEventListener('click', hideResetModal);
            resetContinueBtn.addEventListener('click', resetGameData);
        }
        
        function handleResize() {
            const windowRatio = window.innerWidth / window.innerHeight;
            const gameRatio = baseWidth / baseHeight;
            
            if (windowRatio < gameRatio) {
                gameScale = window.innerWidth / baseWidth;
            } else {
                gameScale = window.innerHeight / baseHeight;
            }
            
            if (!gameContainer.classList.contains('fullscreen')) {
                gameContainer.style.transform = `scale(${gameScale})`;
            }
        }
        
        function toggleFullscreen() {
            if (gameContainer.classList.contains('fullscreen')) {
                gameContainer.classList.remove('fullscreen');
                gameContainer.style.transform = `scale(${gameScale})`;
            } else {
                gameContainer.classList.add('fullscreen');
                gameContainer.style.transform = 'none';
            }
        }
        
        function handleKeyPress(e) {
            if ((e.code === 'Space' || e.code === 'ArrowUp') && gameRunning) {
                birdVelocity = jumpForce;
                animateBirdJump();
                e.preventDefault();
            } else if (e.code === 'KeyF') {
                toggleFullscreen();
                e.preventDefault();
            }
        }
        
        function updateAllHighScoreDisplays() {
            easyHighscoreDisplay.textContent = highScores.easy;
            moderateHighscoreDisplay.textContent = highScores.moderate;
            hardHighscoreDisplay.textContent = highScores.hard;
            updateHighScoreDisplay();
        }
        
        function updateHighScoreDisplay() {
            highScoreDisplay.textContent = `High: ${highScores[currentDifficulty] || 0}`;
        }
        
        function createInitialEnvironment() {
            // Create initial clouds
            for (let i = 0; i < 5; i++) {
                createCloud(true);
            }
        }
        
        function startGame(difficulty) {
            currentDifficulty = difficulty;
            updateHighScoreDisplay();
            
            // Set difficulty
            const settings = difficulties[difficulty];
            gravity = settings.gravity;
            pipeSpeed = settings.pipeSpeed;
            pipeGap = settings.pipeGap;
            pipeFrequency = settings.pipeFrequency;
            jumpForce = settings.jumpForce;
            
            // Reset game state
            cleanUpGameState();
            gameRunning = true;
            score = 0;
            birdY = 300;
            birdVelocity = 0;
            scoreDisplay.textContent = '0';
            
            // Set initial time of day
            setRandomTimeOfDay();
            
            // Hide menu
            menu.classList.add('hidden');
            gameOverScreen.classList.remove('show');
            
            // Position bird
            bird.style.left = '100px';
            bird.style.top = `${birdY}px`;
            bird.style.transform = 'rotate(0deg)';
            
            // Start game loop
            cancelAnimationFrame(animationId);
            lastFrameTime = performance.now();
            animationId = requestAnimationFrame(gameLoop);
            
            // Start pipe generation
            pipeTimer = setInterval(createPipe, pipeFrequency);
            
            // Start cloud generation
            cloudTimer = setInterval(createCloud, 3000);
            
            // Start time of day changes
            timeOfDayTimer = setInterval(changeTimeOfDay, 30000);
            
            // Start weather changes
            startWeatherChanges();
        }
        
        const difficulties = {
            easy: {
                gravity: 0.3,
                pipeSpeed: 2.5,
                pipeGap: 200,
                pipeFrequency: 1800,
                jumpForce: -7,
                color: '#4CAF50'
            },
            moderate: {
                gravity: 0.5,
                pipeSpeed: 3.5,
                pipeGap: 150,
                pipeFrequency: 1400,
                jumpForce: -9,
                color: '#FF9800'
            },
            hard: {
                gravity: 0.7,
                pipeSpeed: 4.5,
                pipeGap: 120,
                pipeFrequency: 1100,
                jumpForce: -11,
                color: '#F44336'
            }
        };
        
        function setRandomTimeOfDay() {
            const times = ['day', 'morning', 'evening', 'night'];
            timeOfDay = times[Math.floor(Math.random() * times.length)];
            updateTimeOfDay();
        }
        
        function changeTimeOfDay() {
            const times = ['day', 'morning', 'evening', 'night'];
            let newTime = times[Math.floor(Math.random() * times.length)];
            while (newTime === timeOfDay) {
                newTime = times[Math.floor(Math.random() * times.length)];
            }
            timeOfDay = newTime;
            updateTimeOfDay();
            
            // Random chance for rain during day/morning/evening (not night)
            if (timeOfDay !== 'night' && Math.random() < 0.3) {
                startRain();
            } else {
                stopRain();
            }
        }
        
        function updateTimeOfDay() {
            gameContainer.className = timeOfDay;
            
            // Update stars for night time
            if (timeOfDay === 'night') {
                createStars();
            } else {
                // Remove stars
                document.querySelectorAll('.star').forEach(star => star.remove());
                stars = [];
            }
        }
        
        function createStars() {
            // Remove existing stars first
            document.querySelectorAll('.star').forEach(star => star.remove());
            stars = [];
            
            // Create new stars
            for (let i = 0; i < 100; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                
                const size = 1 + Math.random() * 2;
                const y = Math.floor(Math.random() * (gameHeight - 100));
                const x = Math.floor(Math.random() * gameWidth);
                
                star.style.left = `${x}px`;
                star.style.top = `${y}px`;
                star.style.width = `${size}px`;
                star.style.height = `${size}px`;
                star.style.animationDelay = `${Math.random() * 2}s`;
                
                gameContainer.appendChild(star);
                stars.push(star);
            }
        }
        
        function startWeatherChanges() {
            // Random chance to start/stop rain periodically
            setInterval(() => {
                if (!isRaining && timeOfDay !== 'night' && Math.random() < 0.2) {
                    startRain();
                } else if (isRaining && Math.random() < 0.3) {
                    stopRain();
                }
            }, 15000);
        }
        
        function startRain() {
            if (isRaining) return;
            isRaining = true;
            gameContainer.classList.add('rain');
            
            // Create rain drops
            rainTimer = setInterval(createRainDrop, 50);
            
            // Random lightning flashes
            if (Math.random() < 0.5) {
                setTimeout(() => {
                    lightning.style.opacity = '0.8';
                    setTimeout(() => {
                        lightning.style.opacity = '0';
                        setTimeout(() => {
                            lightning.style.opacity = '0.6';
                            setTimeout(() => {
                                lightning.style.opacity = '0';
                            }, 50);
                        }, 100);
                    }, 50);
                }, Math.random() * 5000);
            }
        }
        
        function stopRain() {
            if (!isRaining) return;
            isRaining = false;
            gameContainer.classList.remove('rain');
            clearInterval(rainTimer);
            
            // Remove rain drops
            document.querySelectorAll('.rain-drop').forEach(drop => drop.remove());
            rainDrops = [];
        }
        
        function createRainDrop() {
            if (!isRaining) return;
            
            const drop = document.createElement('div');
            drop.className = 'rain-drop';
            drop.style.left = `${Math.random() * gameWidth}px`;
            drop.style.top = '-20px';
            drop.style.height = `${10 + Math.random() * 20}px`;
            drop.style.opacity = `${0.3 + Math.random() * 0.4}`;
            drop.style.animationDuration = `${0.5 + Math.random() * 0.5}s`;
            gameContainer.appendChild(drop);
            
            // Remove after animation completes
            setTimeout(() => {
                drop.remove();
            }, 1000);
        }
        
        function gameLoop(timestamp) {
            if (!gameRunning) return;
            
            // Calculate delta time for smooth animation
            const deltaTime = timestamp - lastFrameTime;
            lastFrameTime = timestamp;
            
            // Update bird position with delta time
            birdVelocity += gravity * (deltaTime / 16);
            birdY += birdVelocity * (deltaTime / 16);
            bird.style.top = `${birdY}px`;
            
            // Rotate bird based on velocity
            const rotation = Math.min(Math.max(birdVelocity * 5, -30), 30);
            bird.style.transform = `rotate(${rotation}deg)`;
            
            // Update pipes
            updatePipes(deltaTime);
            
            // Update clouds
            updateClouds(deltaTime);
            
            // Check collisions
            if (checkCollisions()) {
                endGame();
                return;
            }
            
            // Continue game loop
            animationId = requestAnimationFrame(gameLoop);
        }
        
        function createPipe() {
            if (!gameRunning) return;
            
            const minPipeHeight = 50;
            const maxPipeHeight = gameHeight - pipeGap - minPipeHeight - 50;
            const pipeHeight = Math.floor(Math.random() * (maxPipeHeight - minPipeHeight + 1)) + minPipeHeight;
            
            // Top pipe
            const topPipe = document.createElement('div');
            topPipe.className = 'pipe pipe-top';
            topPipe.style.left = `${gameWidth}px`;
            topPipe.style.top = '0px';
            topPipe.style.height = `${pipeHeight}px`;
            gameContainer.appendChild(topPipe);
            
            // Bottom pipe
            const bottomPipe = document.createElement('div');
            bottomPipe.className = 'pipe pipe-bottom';
            bottomPipe.style.left = `${gameWidth}px`;
            bottomPipe.style.top = `${pipeHeight + pipeGap}px`;
            bottomPipe.style.height = `${gameHeight - pipeHeight - pipeGap - 50}px`;
            gameContainer.appendChild(bottomPipe);
            
            pipes.push({
                top: topPipe,
                bottom: bottomPipe,
                x: gameWidth,
                passed: false
            });
        }
        
        function updatePipes(deltaTime) {
            for (let i = pipes.length - 1; i >= 0; i--) {
                const pipe = pipes[i];
                pipe.x -= pipeSpeed * (deltaTime / 16);
                pipe.top.style.left = `${pipe.x}px`;
                pipe.bottom.style.left = `${pipe.x}px`;
                
                // Check if pipe is passed
                if (!pipe.passed && pipe.x < 100) {
                    pipe.passed = true;
                    score++;
                    scoreDisplay.textContent = score;
                    
                    // Animate score
                    scoreDisplay.style.animation = 'none';
                    void scoreDisplay.offsetWidth;
                    scoreDisplay.style.animation = 'scorePulse 0.5s ease';
                    
                    // Update high score
                    if (score > highScores[currentDifficulty]) {
                        highScores[currentDifficulty] = score;
                        localStorage.setItem(`flappyHighScore${currentDifficulty.charAt(0).toUpperCase() + currentDifficulty.slice(1)}`, score);
                        updateAllHighScoreDisplays();
                        
                        // Show glow effect for new high score
                        glow.classList.add('active');
                        setTimeout(() => glow.classList.remove('active'), 1000);
                    }
                }
                
                // Remove pipes that are off screen
                if (pipe.x < -70) {
                    gameContainer.removeChild(pipe.top);
                    gameContainer.removeChild(pipe.bottom);
                    pipes.splice(i, 1);
                }
            }
        }
        
        function createCloud(initial = false) {
            const cloud = document.createElement('div');
            cloud.className = 'cloud';
            
            const size = Math.floor(Math.random() * 40) + 30;
            const y = Math.floor(Math.random() * (gameHeight / 2));
            
            if (initial) {
                cloud.style.left = `${Math.floor(Math.random() * gameWidth)}px`;
            } else {
                cloud.style.left = `${gameWidth}px`;
            }
            
            cloud.style.top = `${y}px`;
            cloud.style.width = `${size}px`;
            cloud.style.height = `${size / 2}px`;
            
            // Create cloud shape with multiple circles
            const circleCount = Math.floor(Math.random() * 3) + 3;
            for (let i = 0; i < circleCount; i++) {
                const circle = document.createElement('div');
                circle.style.position = 'absolute';
                const circleSize = size * (0.3 + Math.random() * 0.4);
                const circleX = (i * size / (circleCount - 1)) - circleSize / 2;
                const circleY = (Math.random() * size / 3) - circleSize / 3;
                circle.style.width = `${circleSize}px`;
                circle.style.height = `${circleSize}px`;
                circle.style.backgroundColor = 'white';
                circle.style.borderRadius = '50%';
                circle.style.left = `${circleX}px`;
                circle.style.top = `${circleY}px`;
                cloud.appendChild(circle);
            }
            
            gameContainer.appendChild(cloud);
            
            clouds.push({
                element: cloud,
                x: parseInt(cloud.style.left),
                y: y,
                speed: 0.3 + Math.random() * 0.4
            });
        }
        
        function updateClouds(deltaTime) {
            for (let i = clouds.length - 1; i >= 0; i--) {
                const cloud = clouds[i];
                cloud.x -= cloud.speed * (deltaTime / 16);
                cloud.element.style.left = `${cloud.x}px`;
                
                // Remove clouds that are off screen
                if (cloud.x < -100) {
                    gameContainer.removeChild(cloud.element);
                    clouds.splice(i, 1);
                }
            }
        }
        
        function checkCollisions() {
            // Check if bird hits the ground or ceiling
            if (birdY > gameHeight - 80 || birdY < 0) {
                createCollisionParticles();
                return true;
            }
            
            // Check if bird hits any pipes
            const birdRect = {
                x: 100,
                y: birdY,
                width: 40,
                height: 30
            };
            
            for (const pipe of pipes) {
                const topPipeRect = {
                    x: pipe.x,
                    y: 0,
                    width: 70,
                    height: parseInt(pipe.top.style.height)
                };
                
                const bottomPipeRect = {
                    x: pipe.x,
                    y: parseInt(pipe.bottom.style.top),
                    width: 70,
                    height: parseInt(pipe.bottom.style.height)
                };
                
                if (
                    checkRectCollision(birdRect, topPipeRect) ||
                    checkRectCollision(birdRect, bottomPipeRect)
                ) {
                    createCollisionParticles();
                    return true;
                }
            }
            
            return false;
        }
        
        function createCollisionParticles() {
            for (let i = 0; i < 20; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = `${100 + Math.random() * 20}px`;
                particle.style.top = `${birdY + Math.random() * 20}px`;
                particle.style.width = '4px';
                particle.style.height = '4px';
                particle.style.background = '#FFD700';
                gameContainer.appendChild(particle);
                
                // Animate particle
                const angle = Math.random() * Math.PI * 2;
                const speed = 1 + Math.random() * 4;
                const xVel = Math.cos(angle) * speed;
                const yVel = Math.sin(angle) * speed;
                
                let opacity = 1;
                let size = 4;
                const particleInterval = setInterval(() => {
                    opacity -= 0.05;
                    size -= 0.1;
                    particle.style.opacity = opacity;
                    particle.style.width = `${size}px`;
                    particle.style.height = `${size}px`;
                    
                    if (opacity <= 0) {
                        clearInterval(particleInterval);
                        particle.remove();
                    }
                }, 30);
                
                let x = 100 + Math.random() * 20;
                let y = birdY + Math.random() * 20;
                const moveInterval = setInterval(() => {
                    x += xVel;
                    y += yVel;
                    particle.style.left = `${x}px`;
                    particle.style.top = `${y}px`;
                    
                    if (opacity <= 0) {
                        clearInterval(moveInterval);
                    }
                }, 30);
            }
        }
        
        function checkRectCollision(rect1, rect2) {
            return (
                rect1.x < rect2.x + rect2.width &&
                rect1.x + rect1.width > rect2.x &&
                rect1.y < rect2.y + rect2.height &&
                rect1.y + rect1.height > rect2.y
            );
        }
        
        function endGame() {
            gameRunning = false;
            clearInterval(pipeTimer);
            clearInterval(cloudTimer);
            clearInterval(timeOfDayTimer);
            clearInterval(rainTimer);
            cancelAnimationFrame(animationId);
            
            // Show game over screen
            finalScoreDisplay.textContent = `Score: ${score}`;
            
            // Show medal based on score
            medal.style.backgroundImage = '';
            if (score >= highScores[currentDifficulty] && score > 0) {
                medal.style.backgroundImage = 'url("data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 100 100\'><circle cx=\'50\' cy=\'50\' r=\'40\' fill=\'%23FFD700\' stroke=\'%23D4A017\' stroke-width=\'5\'/><path d=\'M30,50 L40,65 L60,65 L70,50 L60,35 L40,35 Z\' fill=\'%23D4A017\'/><text x=\'50\' y=\'55\' font-family=\'Arial\' font-size=\'30\' text-anchor=\'middle\' fill=\'black\'>1</text></svg>")';
            } else if (score >= highScores[currentDifficulty] * 0.7) {
                medal.style.backgroundImage = 'url("data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 100 100\'><circle cx=\'50\' cy=\'50\' r=\'40\' fill=\'%23C0C0C0\' stroke=\'%23A0A0A0\' stroke-width=\'5\'/><path d=\'M30,50 L40,65 L60,65 L70,50 L60,35 L40,35 Z\' fill=\'%23A0A0A0\'/><text x=\'50\' y=\'55\' font-family=\'Arial\' font-size=\'30\' text-anchor=\'middle\' fill=\'black\'>2</text></svg>")';
            } else if (score >= highScores[currentDifficulty] * 0.4) {
                medal.style.backgroundImage = 'url("data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 100 100\'><circle cx=\'50\' cy=\'50\' r=\'40\' fill=\'%23CD7F32\' stroke=\'%23A0522D\' stroke-width=\'5\'/><path d=\'M30,50 L40,65 L60,65 L70,50 L60,35 L40,35 Z\' fill=\'%23A0522D\'/><text x=\'50\' y=\'55\' font-family=\'Arial\' font-size=\'30\' text-anchor=\'middle\' fill=\'black\'>3</text></svg>")';
            }
            
            gameOverScreen.classList.add('show');
            
            // Create confetti for good scores
            if (score >= highScores[currentDifficulty] * 0.5) {
                createConfetti();
            }
        }
        
        function createConfetti() {
            const colors = ['#FFD700', '#FF4500', '#4CAF50', '#2196F3', '#9C27B0'];
            
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = `${Math.random() * gameWidth}px`;
                confetti.style.top = `${-10}px`;
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
                confetti.style.width = `${10 + Math.random() * 10}px`;
                confetti.style.height = `${5 + Math.random() * 5}px`;
                gameContainer.appendChild(confetti);
                
                // Animate confetti
                const angle = Math.random() * Math.PI * 2;
                const speed = 2 + Math.random() * 3;
                const xVel = Math.cos(angle) * speed;
                const rotationSpeed = (Math.random() - 0.5) * 20;
                
                let y = -10;
                let x = parseInt(confetti.style.left);
                let rotation = parseInt(confetti.style.transform.replace('rotate(', '').replace('deg)', ''));
                let opacity = 0;
                
                // Fade in
                const fadeIn = setInterval(() => {
                    opacity += 0.05;
                    confetti.style.opacity = opacity;
                    if (opacity >= 1) clearInterval(fadeIn);
                }, 30);
                
                const fallInterval = setInterval(() => {
                    y += speed;
                    x += xVel;
                    rotation += rotationSpeed;
                    confetti.style.top = `${y}px`;
                    confetti.style.left = `${x}px`;
                    confetti.style.transform = `rotate(${rotation}deg)`;
                    
                    if (y > gameHeight) {
                        clearInterval(fallInterval);
                        // Fade out
                        const fadeOut = setInterval(() => {
                            opacity -= 0.05;
                            confetti.style.opacity = opacity;
                            if (opacity <= 0) {
                                clearInterval(fadeOut);
                                confetti.remove();
                            }
                        }, 30);
                    }
                }, 30);
            }
        }
        
        function restartGame() {
            cleanUpGameState();
            startGame(currentDifficulty);
        }
        
        function returnToMenu() {
            cleanUpGameState();
            menu.classList.remove('hidden');
            gameOverScreen.classList.remove('show');
        }
        
        function cleanUpGameState() {
            // Cancel all animations and intervals
            cancelAnimationFrame(animationId);
            clearInterval(pipeTimer);
            clearInterval(cloudTimer);
            clearInterval(timeOfDayTimer);
            clearInterval(rainTimer);
            
            // Remove all game elements efficiently
            const elementsToRemove = [
                ...document.querySelectorAll('.pipe'),
                ...document.querySelectorAll('.cloud'),
                ...document.querySelectorAll('.star'),
                ...document.querySelectorAll('.rain-drop'),
                ...document.querySelectorAll('.particle'),
                ...document.querySelectorAll('.confetti')
            ];
            
            elementsToRemove.forEach(el => el.remove());
            
            // Reset all game state variables
            pipes = [];
            clouds = [];
            stars = [];
            rainDrops = [];
            gameRunning = false;
            score = 0;
            birdY = 300;
            birdVelocity = 0;
            
            // Reset bird position
            bird.style.left = '100px';
            bird.style.top = '300px';
            bird.style.transform = 'rotate(0deg)';
            
            // Reset time of day
            gameContainer.className = 'day';
            timeOfDay = 'day';
            isRaining = false;
            
            // Reset displays
            scoreDisplay.textContent = '0';
            finalScoreDisplay.textContent = 'Score: 0';
            medal.style.backgroundImage = '';
            glow.classList.remove('active');
        }
        
        function resetGameData() {
            cleanUpGameState();
            
            // Clear all high scores
            highScores = {
                easy: 0,
                moderate: 0,
                hard: 0
            };
            
            // Remove from localStorage
            localStorage.removeItem('flappyHighScoreEasy');
            localStorage.removeItem('flappyHighScoreModerate');
            localStorage.removeItem('flappyHighScoreHard');
            
            // Update displays
            updateAllHighScoreDisplays();
            
            // Hide modal
            hideResetModal();
            
            // Return to menu
            menu.classList.remove('hidden');
            gameOverScreen.classList.remove('show');
        }
        
        function showResetModal() {
            resetModal.classList.add('show');
        }
        
        function hideResetModal() {
            resetModal.classList.remove('show');
        }
        
        function animateBirdJump() {
            bird.style.transform = 'scale(1.1, 0.9) rotate(-20deg)';
            setTimeout(() => {
                bird.style.transform = 'scale(1)';
            }, 100);
        }
        
        function handleClick() {
            if (gameRunning) {
                birdVelocity = jumpForce;
                animateBirdJump();
            }
        }
        
        // Initialize the game
        initGame();
    </script>
</body>
</html>
